// Jenkinsfile executing in two containers on the same node
pipeline {
    // Assuming python 3.10 and docker / docker compose are available on the main node.
    agent {
        kubernetes {
            defaultContainer 'python'
            yaml """
                apiVersion: v1
                kind: Pod
                metadata:
                  labels:
                    jenkins: build-node
                spec:
                    containers:
                    - name: python
                      image: ghcr.io/rocs-org/python-test-environment:latest
                      command:
                      - cat
                      tty: true
                      env:
                      - name: http_proxy
                        value: http://10.15.156.29:8020
                      - name: https_proxy
                        value: http://10.15.156.29:8020
                      - name: NO_PROXY
                        value: localhost
                      - name: DB_PASSWORD
                        value: password
                      - name: DB_USER
                        value: user
                      - name: DB_NAME
                        value: test_db
                      - name: DB_HOSTNAME
                        value: localhost
                      - name: DB_PORT
                        value: 5432
                      ports:
                      - containerPort: 8080
                    - name: postgres
                      image: postgres:latest
                      tty: true
                      env:
                      - name: POSTGRES_PASSWORD
                        value: password
                      - name: POSTGRES_USER
                        value: user
                      - name: POSTGRES_DB
                        value: test_db
                      ports:
                      - containerPort: 5432
                      readinessProbe:
                        exec:
                          command:
                          - pg_isready
                          - -U
                          - user
                    restartPolicy: Never
                """
            }
    }
    stages {
        stage('Setup'){
            steps {
                sh 'poetry --version'
                // Checkout the code
                checkout scm
                // Install dependencies
                sh 'make install'
                // 'run database migrations'
                sh 'make migrate'

            }
        }
        stage('Test and lint') {
            steps {
                // Run linting
                sh 'make lint'
                // Run tests
                sh 'make test'
            }
        }
    }
}
